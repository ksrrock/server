-- source include/have_innodb.inc
-- source include/have_file_key_management_plugin.inc

--disable_query_log
let $innodb_file_format_orig = `SELECT @@innodb_file_format`;
let $innodb_file_per_table_orig = `SELECT @@innodb_file_per_table`;
--enable_query_log

--disable_warnings
SET GLOBAL innodb_file_format = `Barracuda`;
SET GLOBAL innodb_file_per_table = ON;
--enable_warnings

SET GLOBAL innodb_encrypt_tables = OFF;
SET GLOBAL innodb_default_encryption_key_id = 1;

create table t1 (a int not null primary key) engine=InnoDB;

# Do not allow setting default key to key_id that is not found
--error ER_WRONG_VALUE_FOR_VAR
SET GLOBAL innodb_default_encryption_key_id = 999;
SHOW WARNINGS;

SET GLOBAL innodb_default_encryption_key_id = 4;
SET GLOBAL innodb_encryption_threads = 4;
SET GLOBAL innodb_encrypt_tables = ON;

--let $tables_count= `select count(*) from information_schema.tables where engine = 'InnoDB'`
--let $wait_condition=SELECT COUNT(*) = $tables_count + 1 FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0 AND ROTATING_OR_FLUSHING = 0;
--source include/wait_condition.inc

SELECT NAME,CURRENT_KEY_ID,MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0 ORDER BY NAME;
SELECT NAME,CURRENT_KEY_ID,MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0 ORDER BY NAME;

--echo # Success!

DROP TABLE t1;

--disable_warnings
SET GLOBAL innodb_encryption_threads = DEFAULT;
SET GLOBAL innodb_encrypt_tables = DEFAULT;
SET GLOBAL innodb_file_format = DEFAULT;
SET GLOBAL innodb_file_per_table = DEFAULT;
SET GLOBAL innodb_default_encryption_key_id = DEFAULT;
--enable_warnings
